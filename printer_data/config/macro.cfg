#==============================================================================
# PID Hot End Calibration 
#==============================================================================
[gcode_macro PID_Hotend]
description: Calibrate Hotend
gcode: 
      M106 S255
      PID_CALIBRATE HEATER=extruder TARGET=230

#==============================================================================
# PID BED Calibration 
#==============================================================================      
[gcode_macro PID_BED]
description: Calibrate BED
gcode: 
      M106 S255
      PID_CALIBRATE HEATER=heater_bed TARGET=100

#==============================================================================
# LED colours
#==============================================================================
[gcode_macro White]
gcode:
 set_led LED=sb_leds RED=1 GREEN=1 BLUE=1
[gcode_macro Red]
gcode:
 set_led LED=sb_leds RED=1 GREEN=0 BLUE=0
[gcode_macro Blue]
gcode:
 set_led LED=sb_leds RED=0 GREEN=0 BLUE=1
[gcode_macro Green]
gcode:
 set_led LED=sb_leds RED=0 GREEN=1 BLUE=0
[gcode_macro Purple]
gcode: 
 set_led LED=sb_leds RED=0.1294 GREEN=0 BLUE=0.0902

#==============================================================================
# SET Square Corner Veolicity
#==============================================================================
[gcode_macro SET_SQV]
gcode:
  {% set multiplier = params.MULTIPLIER|default(0.01)|float %}
  {% set layer = params.LAYER|default(1)|float %}
  {% set sqv = multiplier * layer %}
  {% if layer <= 1 %}
    {% set sqv = 2 %}
  {% endif %}
  RESPOND TYPE=echo MSG='{"set sqv: multi: %f, layer: %f, final sqv: %f" % (multiplier, layer, sqv) }'
  SET_DISPLAY_TEXT MSG='{"S%.1f M%.2f L%.0f " % (sqv, multiplier, layer) }'
  SET_VELOCITY_LIMIT SQUARE_CORNER_VELOCITY={ sqv }

#==============================================================================
# BD Sensor Cailbrate Check
#==============================================================================
[gcode_macro BDsensor_calibration_check]
gcode:   
  M102 S-5
#==============================================================================
# BD Sensor Calibration
#==============================================================================
[gcode_macro BDsensor_calibration_]
gcode:   
  M102 S-6  
#==============================================================================
# BD Sensor Start Calibration
#==============================================================================
[gcode_macro BDsensor_start_calibration]
gcode: 
  SET_KINEMATIC_POSITION Z=50

#==============================================================================
# Acrs
#==============================================================================
[gcode_arcs]
resolution: 0.1

#==============================================================================
# Stepper Fans
#==============================================================================
[gcode_macro Stepper_Fans]
gcode:
    SET_FAN_SPEED FAN=stepper_fan SPEED=0.8

#==============================================================================
# Printer Pre-heat
#==============================================================================
[gcode_macro Printer_Pre_heat_ABS]
gcode:
    SET_IDLE_TIMEOUT TIMEOUT=7200
    SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET=105
    M104 S175
    status_heating
    
#==============================================================================
# Printer Pre-heat
#==============================================================================
[gcode_macro Printer_Pre_heat_PLA]
gcode:
    SET_IDLE_TIMEOUT TIMEOUT=7200
    SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET=70
    M104 S145
    status_heating
    
#==============================================================================
# Enable Stepper Motors
#==============================================================================
[gcode_macro enable_stepper]
gcode:
 SET_STEPPER_ENABLE STEPPER=stepper_x ENABLE=1
 SET_STEPPER_ENABLE STEPPER=stepper_x1 ENABLE=1
 SET_STEPPER_ENABLE STEPPER=stepper_y ENABLE=1
 SET_STEPPER_ENABLE STEPPER=stepper_y1 ENABLE=1

#==============================================================================
# Screw Tilt Adjust
#==============================================================================
[gcode_macro Screw_tilt_adjust]
gcode:
  SET_FAN_SPEED FAN=stepper_fan SPEED=0.8
  SCREWS_TILT_CALCULATE

#==============================================================================
# ACCELEROMETER_QUERY
#==============================================================================
[gcode_macro ACCELEROMETER_check]
gcode:
 ACCELEROMETER_QUERY


#==============================================================================
# Resonnance Test
#==============================================================================
[gcode_macro TEST_RESONNANCE]
gcode:
 SET_FAN_SPEED FAN=stepper_fan SPEED=0.90
 SHAPER_CALIBRATE

#==============================================================================
# Resonnance Test X
#==============================================================================
[gcode_macro TEST_RESONNANCES_X]
gcode:
 TEST_RESONANCES AXIS=X

#==============================================================================
# Resonnance Test Y
#==============================================================================
[gcode_macro TEST_RESONNANCES_Y]
gcode:
 TEST_RESONANCES AXIS=Y

#==============================================================================
# PA Tuning 
#==============================================================================
[gcode_macro PA_tunning]
gcode: 
	SET_VELOCITY_LIMIT SQUARE_CORNER_VELOCITY=1 ACCEL=500
	TUNING_TOWER COMMAND=SET_PRESSURE_ADVANCE PARAMETER=ADVANCE START=0 FACTOR=.005

#==============================================================================
# Retraction Test Up
#==============================================================================
[gcode_macro RETRACTION_UP]
gcode:
    {% set CRLEN = printer.firmware_retraction.retract_length|float %}
    {% set NRLEN = CRLEN|float + 0.1 %}
    { action_respond_info("current retract_length %.2f, new retract_length %.2f" % (CRLEN, NRLEN))  }
    SET_RETRACTION RETRACT_LENGTH={NRLEN}    

#==============================================================================
# Retraction Test Down
#==============================================================================
[gcode_macro RETRACTION_DOWN]
gcode:
    {% set CRLEN = printer.firmware_retraction.retract_length|float %}
    {% set NRLEN = CRLEN|float - 0.1 %}
    { action_respond_info("current retract_length %.2f, new retract_length %.2f" % (CRLEN, NRLEN))  }
    SET_RETRACTION RETRACT_LENGTH={NRLEN} 

#==============================================================================
# XY Exercise
#==============================================================================
   
[gcode_macro XY_exercise]
variable_start_x: 2
variable_end_x: 235
variable_start_y: 2
variable_end_y: 235
variable_start_z: 10
variable_exerrcise_qty: 3
variable_speed: 100
variable_raise_distance: 10

gcode:
 {% if "xyz" not in printer.toolhead.homed_axes %}
   G28
 {% endif %}

 Stepper_Fans
 G90                                            ; absolute positioning
 ## Move nozzle to start position
  G1 Z{start_z} F1500
  G1 X{start_x} Y{start_y} F6000

 ## Wipe nozzle
 {% for wipes in range(1, (exerrcise_qty + 1)) %}
   #WIPE LEFT
   G1 X{start_x} Y{start_y} F{speed * 300}
   G1 X{start_x} Y{end_y  } F{speed * 300}
   G1 X{end_x} Y{end_y} F{speed * 300}
   G1 X{end_x} Y{start_y} F{speed * 300}
   G1 X{start_x} Y{end_y} F{speed * 300}
   G1 X{end_x} Y{end_y} F{speed * 300}
   G1 X{start_x} Y{start_y} F{speed * 300}
   
 {% endfor %}

 ## Raise nozzle after complete
 G1 Z{raise_distance}
 G1 Y 2

#==============================================================================
# Prime Line
#==============================================================================
[gcode_macro PRIME_LINE]
description: "Prime the nozzle with a customizable line"
variable_length: 100 ; Total length of the prime line in mm
variable_extra_flow: 5 ; Extra flow for the last 20 mm in mm
variable_height: 0.2 ; Height of the prime line in mm
variable_offset: 5 ; Height to lift the nozzle off the bed after priming
variable_start_x: 0 ; Starting X position in mm
variable_start_y: 0 ; Starting Y position in mm

gcode:
    G1 Z{height} ; Move to the starting height
    G1 F1000 ; Set feedrate for movement
    G1 X{start_x} Y{start_y} ; Move to the start position
    G1 F200 E{length - 20} ; Extrude the initial part of the line
    G1 F200 E{extra_flow} ; Add extra flow for the last 20 mm
    G1 X{start_x + length} ; Move in X direction to the end of the prime line
    G1 F200 E-{length} ; Retract the total length of the prime line
    G1 F2100 E-1 ; Retract 1 mm at 35 mm/s
    G1 Z{offset} ; Lift the nozzle off the bed

#==============================================================================
# Exercise print area
#==============================================================================
[gcode_macro EXERCISE_PRINT_AREA]
description: "Move the nozzle around the print area for exercise, maintaining 5mm above the bed, including Z movements, and allowing repetitions"
variable_width: 235 ; Width of the print area in mm
variable_depth: 235 ; Depth of the print area in mm
variable_height: 250 ; Maximum height to move the nozzle
variable_speed: 3000 ; Speed for X/Y movements in mm/min
variable_bed_speed: 1000 ; Speed for Z movements in mm/min
variable_nozzle_offset: 5 ; Height to maintain above the bed
variable_repeats: 1 ; Number of times to repeat the exercise

gcode:
    ; Set movement speeds
    G1 F{speed} ; Set the movement speed for X/Y

    {% for i in range(0, repeats) %}
        ; Move to starting position
        G1 Z{nozzle_offset} ; Start at the nozzle offset height
        G1 X0 Y0 ; Move to the starting position

        ; Move around the print area at the nozzle height
        G1 X{width} Y0 ; Move to the right edge
        G1 X{width} Y{depth} ; Move to the back edge
        G1 X0 Y{depth} ; Move to the left edge
        G1 X0 Y0 ; Return to the starting position

        ; Move Z to the maximum height
        G1 F{bed_speed} ; Set the movement speed for Z
        G1 Z{height} ; Move up to the maximum height

        ; Move around the print area again at maximum height
        G1 F{speed} ; Restore X/Y speed
        G1 X{width} Y0 ; Move to the right edge
        G1 X{width} Y{depth} ; Move to the back edge
        G1 X0 Y{depth} ; Move to the left edge
        G1 X0 Y0 ; Return to the starting position

        ; Move back down to the nozzle offset height
        G1 Z{nozzle_offset} ; Move back down to 5 mm above the bed

        ; Perform final move around the print area at the nozzle height
        G1 F{speed} ; Restore X/Y speed
        G1 X{width} Y0 ; Move to the right edge
        G1 X{width} Y{depth} ; Move to the back edge
        G1 X0 Y{depth} ; Move to the left edge
        G1 X0 Y0 ; Return to the starting position
    {% endfor %}

#==============================================================================
# Nozzle Wipe
#==============================================================================    
[gcode_macro NOZZLE_WIPE]
description: "Wipes the nozzle from a starting position to an end position, with customizable parameters. Includes a nozzle lift before and after the wipe."

# --- Configuration Variables ---
variable_wipe_x_start: 92  ; Starting X position for the nozzle wipe (in mm)
variable_wipe_x_finish: 132  ; Finishing X position for the nozzle wipe (in mm)
variable_wipe_y: 235  ; Y position for the nozzle wipe (in mm)
variable_wipe_z: 0.4  ; Z height for the nozzle wipe (in mm)
variable_lift_z: 5.0  ; Z height to lift the nozzle before and after wipe (in mm)
variable_move_speed: 7500  ; Speed for moving the nozzle (in mm/min)
variable_nozzle_wipes: 6  ; Number of times to repeat the nozzle wipe

gcode:

    
    # Debugging output to check variables
    M117 Wipe Start X: {wipe_x_start} Wipe Finish X: {wipe_x_finish} ; Debugging output
    
    # Step 2: Lift the nozzle to a safe height before starting the wipe
    G90  ; Set to absolute positioning mode (ensure absolute moves)
    G1 Z{lift_z} F{move_speed}  ; Lift the nozzle to avoid bed contact before starting wipe
    
    # Step 3: Move to wipe start position
    G1 X{wipe_x_start} Y{wipe_y} Z{wipe_z} F{move_speed}  ; Move to start location
    
    # Step 4: Repeat the nozzle wipe for the specified number of cycles
    {% for i in range(nozzle_wipes) %}
        ; Wipe cycle {{ i+1 }} of {{ nozzle_wipes }}
        
        # Move to the starting X position for the wipe (no Z movement during wipe)
        G1 X{wipe_x_start} Y{wipe_y} Z{wipe_z} F{move_speed}  ; Move to wipe start location
        
        # Move to the finishing X position for the wipe (no Z movement during wipe)
        G1 X{wipe_x_finish} Y{wipe_y} Z{wipe_z} F{move_speed}  ; Wipe across to finish position
    {% endfor %}
    
    # Step 5: Lift the nozzle after completing all wipe cycles
    G1 Z{lift_z} F{move_speed}  ; Lift the Z axis after all wipes are done
    
    # Step 6: Return to starting position (optional)
    G1 X{wipe_x_start} Y{wipe_y} Z{lift_z} F{move_speed}  ; Return to wipe start position

#==============================================================================
# Prime Line
#============================================================================== 

[gcode_macro PRIME_LINE]
description: "Prime the nozzle with a customizable line using various configurable parameters."

# --- Configuration Variables ---
variable_prime_lift_z: 0.6  ; Z height to lift the nozzle before starting (in mm)
variable_prime_x: 4.0  ; X position for the prime location (in mm)
variable_prime_y: 2.0  ; Y position for the prime location (in mm)
variable_prime_z: 0.4  ; Z height for the prime (in mm)
variable_prime_z_plus_0_2: 0.6  ; Z height for the prime + 0.2 mm (calculated)
variable_extrude_amount: 15  ; Amount of filament to extrude during priming (in mm)
variable_extrude_speed: 600  ; Speed of extrusion during priming (mm/min)
variable_intro_line_speed: 1000  ; Speed for intro line (mm/min)
variable_intro_line_1_x: 60.0  ; X position for first intro line (in mm)
variable_intro_line_1_e: 9.0  ; Amount to extrude for first intro line (in mm)
variable_intro_line_2_x: 100.0  ; X position for second intro line (in mm)
variable_intro_line_2_e: 23.5  ; Amount to extrude for second intro line (in mm)
variable_safe_z: 2.0  ; Z height to return to after prime (in mm)

gcode:
    # Step 1: Lift the nozzle to a safe height before moving to the prime location
    G1 Z{variable_prime_lift_z} F5000  ; Lift nozzle to {variable_prime_lift_z} mm height
    
    # Step 2: Move to the prime location
    G1 X{variable_prime_x} Y{variable_prime_y} F5000  ; Move to prime location {variable_prime_x}, {variable_prime_y}
    
    # Step 3: Lower the nozzle to priming height
    G1 Z{variable_prime_z} F2500  ; Move to priming Z height {variable_prime_z}
    
    # Step 4: Wait for hotend to reach the target temperature
    M109 S{hotend_temp}  ; Set and wait for hotend temperature {variable_hotend_temp} °C 
    
    # Step 5: Extrude filament to prime the nozzle
    G1 E{variable_extrude_amount} F{variable_extrude_speed}  ; Extrude {variable_extrude_amount} mm of filament at {variable_extrude_speed} mm/min
    
    # Step 6: Move to a safe Z height after priming
    G1 Z{variable_prime_z_plus_0_2} F240  ; Move up slightly to avoid bed contact
    
    # Step 7: Reset extruder position
    G92 E0  ; Reset extruder position to 0
    
    # Step 8: Move to lay down intro line #1
    G1 X{variable_intro_line_1_x} E{variable_intro_line_1_e} F{variable_intro_line_speed}  ; Move to X{variable_intro_line_1_x} and extrude {variable_intro_line_1_e} mm at {variable_intro_line_speed} mm/min
    
    # Step 9: Move to lay down intro line #2
    G1 X{variable_intro_line_2_x} E{variable_intro_line_2_e} F{variable_intro_line_speed}  ; Move to X{variable_intro_line_2_x} and extrude {variable_intro_line_2_e} mm at {variable_intro_line_speed} mm/min
    
    # Step 10: Zero extruder after intro line
    G92 E0  ; Zero the extruder distance position
    
    # Step 11: Return to safe Z height
    G1 Z{variable_safe_z} F5000  ; Return to safe Z height {variable_safe_z} mm
    
    # Step 12: Set absolute positioning for future moves
    G90  ; Set to absolute positioning mode




    