[gcode_macro PRINT_START]
description: "Prime the nozzle with a customizable line, including a high-speed nozzle wipe with multiple passes"

# Default Parameters (can be overridden by slicer or manually)
# --- Configuration Variables ---
variable_wipe_x_start: 92  ; Starting X position for the nozzle wipe (in mm)
variable_wipe_x_finish: 80  ; Finishing X position for the nozzle wipe (in mm)
variable_wipe_y: 235  ; Starting Y position for the nozzle wipe (in mm)
variable_wipe_z: 0.4  ; Starting Z position for the nozzle wipe (in mm)
variable_lift_z: 5.0  ; Z height to lift the nozzle before wipe (in mm)
variable_move_speed: 1500  ; Speed for moving to the wipe position (in mm/min)
variable_fan_speed: 0.7  ; Cooling fan speed (0 to 1)
variable_nozzle_wipes: 6  ; Number of times to repeat the nozzle wipe

#[gcode_macro PRINT_START]
gcode:
    # Parameters
    #{% set bedtemp = params.BED|int %}
    #{% set hotendtemp = params.HOTEND|int %}
    #{% set bedtemp = params.BED|default(60)|int %}
    #{% set hotendtemp = params.HOTEND|default(200)|int %}
    
    # Step 1: Turn on the lights (maximum brightness)
    LIGHTS_MAX  ; Call the lights_max macro to turn the lights on
    # Step 2: Set the fan speed
    SET_FAN_SPEED FAN=stepper_fan SPEED={printer["variable_fan_speed"]}
    # Step 3: 
    M104 S155 ; set extruder to 155deg
    # Step 4: Wait for the bed to reach target temperature
    #M190 S{bedtemp}; Heat the bed and wait for it to reach target temperature
    M190 S{50}
    # Step 5: Home all axes after setting the extruder temperature
    G28  ; Home all axes
    # Step 6: RTun auto bed mesh
    BED_MESH_CALIBRATE ADAPTIVE=1
    # Step 7: Lift Z 5mm above bed
    G1 Z{printer["variable_lift_z"]} F{printer["variable_move_speed"]}
    # Step 8: Repeat the nozzle wipe for the specified number of times
    {% for i in range(printer["variable_nozzle_wipes"]) %}
    ; Wipe cycle {{ i+1 }} of {{ printer["variable_nozzle_wipes"] }}
    ; Move to the starting X position
    G1 X{printer["variable_wipe_x_start"]} Y{printer["variable_wipe_y"]} Z{printer["variable_wipe_z"]} F{printer["variable_move_speed"]} ; Move to wipe start location
    ; Move to the finishing X position
    G1 X{printer["variable_wipe_x_finish"]} Y{printer["variable_wipe_y"]} Z{printer["variable_wipe_z"]} F{printer["variable_move_speed"]} ; Wipe across to finish position
    ; Lift Z axis after wipe
    G1 Z{printer["variable_lift_z"]} F{printer["variable_move_speed"]} ; Lift the Z axis after wipe
    {% endfor %}
    # Step 9: Move to prime location
    G1 Z{printer["variable_lift_z"]} F{printer["variable_move_speed"]}
