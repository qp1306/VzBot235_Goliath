[gcode_macro PRINT_START]
description: "Prime the nozzle with a customizable line, including a high-speed nozzle wipe with multiple passes"

# Default Parameters (can be overridden by slicer or manually)
variable_bedtemp: 60  ; Bed temperature in °C
variable_hotendtemp: 200  ; Hotend temperature in °C
variable_extruder_temp: 155  ; Extruder temperature for priming (in °C)
variable_lift_nozzle_height: 0.5  ; Nozzle lift height before wiping (in mm)
variable_lift_speed: 500  ; Speed for lifting the nozzle (in mm/min)
variable_wipe_x: 10  ; Starting X position for the nozzle wipe (in mm)
variable_wipe_y: 10  ; Starting Y position for the nozzle wipe (in mm)
variable_wipe_end_x: 100  ; Ending X position for the nozzle wipe (in mm)
variable_wipe_speed: 20000  ; Speed for the nozzle wipe (in mm/min)
variable_wipe_repeats: 3  ; Number of times to repeat the nozzle wipe (back and forth)
variable_prime_start_x: 20  ; Starting X position for the prime line (in mm)
variable_prime_start_y: 20  ; Starting Y position for the prime line (in mm)
variable_prime_end_x: 120  ; Ending X position for the prime line (in mm)
variable_prime_end_y: 20  ; Ending Y position for the prime line (in mm)
variable_prime_speed: 1000  ; Speed for the prime line (in mm/min)
variable_prime_flow_rate: 0.95  ; Extruder flow rate for the prime line (adjustable)

gcode:
    # Set and wait for the bed temperature using the passed parameter or default value
    {% if params.BED is defined %}
        {% set bedtemp = params.BED|int %}
    {% else %}
        {% set bedtemp = variable_bedtemp %}
    {% endif %}
    M190 S{bedtemp} ; Set and wait for bed temperature

    # Home all axes
    G28 ; Home all axes

    # Set extruder to the priming temperature (155°C)
    M104 S{variable_extruder_temp} ; Set extruder to 155°C for priming

    # Perform adaptive bed mesh calibration
    BED_MESH_CALIBRATE ADAPTIVE=1 ; Run adaptive bed mesh calibration

    # Lift the nozzle to the specified height before wiping
    G1 Z{variable_lift_nozzle_height} F{variable_lift_speed} ; Lift nozzle to specified height

    # Move to wipe location (with speed and offset)
    G1 X{variable_wipe_x - 5} Y{variable_wipe_y} F{variable_lift_speed} ; Move to the start of the wipe location (offset by 5mm for clearance)

    # Perform nozzle wipe (back and forth, repeat as specified)
    G1 F{variable_wipe_speed} ; Set speed for nozzle wipe
    {% for i in range(variable_wipe_repeats) %}
        G1 X{variable_wipe_end_x} ; Move to the end of the wipe area
        G1 X{variable_wipe_x - 5} ; Move back to the start of the wipe area
    {% endfor %}

    # Set extruder temperature to the final value (hotend temperature) and wait
    {% if params.HOTEND is defined %}
        {% set hotendtemp = params.HOTEND|int %}
    {% else %}
        {% set hotendtemp = variable_hotendtemp %}
    {% endif %}
    M109 S{hotendtemp} ; Set and wait for hotend temperature

    # Move to the prime line start position
    G1 X{variable_prime_start_x} Y{variable_prime_start_y} F{variable_prime_speed} ; Move to prime line start position

    # Prime the nozzle along the prime line (extrude filament)
    G1 Z{variable_lift_nozzle_height} F{variable_lift_speed} ; Ensure nozzle is at the correct height
    G1 F{variable_prime_speed} ; Set prime line speed
    G1 E{variable_prime_end_x - variable_prime_start_x} ; Extrude filament for the prime line length
    G1 X{variable_prime_end_x} Y{variable_prime_end_y} ; Move to the end position of the prime line

    # Retract filament after priming
    G1 F200 E-{variable_prime_end_x - variable_prime_start_x} ; Retract the filament after priming
    G1 F2100 E-1 ; Retract 1mm at 35 mm/s

    # Lift nozzle to a safe height after priming
    G1 Z10 F{variable_lift_speed} ; Lift nozzle to a safe height after priming

    # Prepare for printing
    G92 E0 ; Zero the extruder position
    G1 F9000 ; Set feedrate for travel movements
    G0 Z2 ; Move Z to 2mm height for clearance
    G90 ; Absolute positioning mode for safe movements
