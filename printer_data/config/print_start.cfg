[gcode_macro PRINT_START]
description: "Prime the nozzle with a customizable line, including a high-speed nozzle wipe with multiple passes"

# Parameters for easy customization
variable_bedtemp: 60  ; Bed temperature in °C
variable_hotendtemp: 200  ; Hotend temperature in °C
variable_extruder_temp: 155  ; Extruder temperature for priming (in °C)
variable_lift_nozzle_height: 0.5  ; Nozzle lift height before wiping (in mm)
variable_lift_speed: 500  ; Speed for lifting the nozzle (in mm/min)
variable_travel_speed: 800 ; Speed to travel (in mm/min)
variable_wipe_x: 92 ; Starting X position for the nozzle wipe (in mm)
variable_wipe_y: 235  ; Starting Y position for the nozzle wipe (in mm)
variable_wipe_end_x: 100  ; Ending X position for the nozzle wipe (in mm)
variable_wipe_speed: 20000  ; Speed for the nozzle wipe (in mm/min)
variable_wipe_repeats: 3  ; Number of times to repeat the nozzle wipe (back and forth)
variable_prime_start_x: 20  ; Starting X position for the prime line (in mm)
variable_prime_start_y: 20  ; Starting Y position for the prime line (in mm)
variable_prime_end_x: 120  ; Ending X position for the prime line (in mm)
variable_prime_end_y: 20  ; Ending Y position for the prime line (in mm)
variable_prime_speed: 1000  ; Speed for the prime line (in mm/min)
variable_prime_flow_rate: 0.95  ; Extruder flow rate for the prime line (adjustable)

gcode:
    # 1. Set and wait for the bed temperature using the passed parameter
    {% set bedtemp = params.BED|int %}
    M190 S{bedtemp} ; Set and wait for bed temperature

    # 2. Home all axes
    G28 ; Home all axes

    # 3. Set extruder to 155°C for priming
    M104 S{variable_extruder_temp} ; Set extruder to 155°C for priming

    # 4. Perform adaptive bed mesh calibration
    BED_MESH_CALIBRATE ADAPTIVE=1 ; Run the adaptive bed mesh calibration

    # 5. Lift nozzle to the specified height before wiping
    G1 Z{variable_lift_nozzle_height} F{variable_lift_speed} ; Lift the nozzle to the specified height

    # 6. Move to wipe location (adjust X position by -5mm for clearance)
    G1 X{variable_wipe_x - 5} Y{variable_wipe_y} F{variable_travel_speed} ; Move to the start of the wipe location (5mm offset for clearance)

    # 7. Set the extruder temperature to the final value (hotend temperature) and wait
    M109 S{variable_hotendtemp} ; Set and wait for hotend temperature

    # 8. Perform nozzle wipe (move back and forth, repeat specified number of times)
    G1 F{variable_wipe_speed} ; Set the speed for the wipe
    {% for i in range(variable_wipe_repeats) %}
     G1 X{variable_wipe_end_x} ; Move to the end of the wipe area
     G1 X{variable_wipe_x} ; Move back to the start of the wipe area
    {% endfor %}
	


    # 9. Move to the prime line start location
    G1 X{variable_prime_start_x} Y{variable_prime_start_y} F{variable_travel_speed} ; Move to the prime line start position

    # 10. Prime the nozzle along the prime line (extrude filament)
    G1 Z{variable_lift_nozzle_height} F{variable_lift_speed} ; Ensure the nozzle is at the correct height for priming
    G1 F{variable_prime_speed} ; Set the speed for the prime line extrusion
    G1 E{variable_prime_end_x - variable_prime_start_x} ; Extrude the filament for the prime line
    G1 X{variable_prime_end_x} Y{variable_prime_end_y} ; Move to the prime line end position

    # 11. Retract filament after priming
    G1 F200 E-{variable_prime_end_x - variable_prime_start_x} ; Retract the filament after priming
    G1 F2100 E-1 ; Retract 1 mm at 35 mm/s

    # 12. Lift the nozzle to a safe height after priming
    G1 Z2 F{variable_lift_speed} ; Lift the nozzle to a safe height after priming

    # 13. Ready to print
    # 14. G92 E0 ; Zero the extruder position
    # 15. G90 ; Absolute positioning mode for safe movements
